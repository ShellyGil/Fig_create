<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Figure Generator</title>
    <script src="https://cdn.jsdelivr.net/npm/utif@3.1.0/UTIF.js"></script>
    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; --text: #1e293b; --border: #e2e8f0; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); color: var(--text); padding: 20px; max-width: 1400px; margin: 0 auto; }
        
        .app-container { display: flex; gap: 20px; flex-direction: column; }
        .panel { background: white; padding: 20px; border-radius: 8px; border: 1px solid var(--border); box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        h2 { margin-top:0; font-size:18px; color: #334155; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px; }
        h3 { margin: 15px 0 10px 0; font-size: 14px; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; }

        /* Configuration Flex layout */
        .config-row { display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap; }
        
        .input-group { display: flex; flex-direction: column; gap: 5px; }
        .input-group label { font-size: 12px; font-weight: bold; color: #64748b; }
        
        /* Inputs */
        input[type="number"], input[type="text"], select { padding: 6px; border: 1px solid #cbd5e1; border-radius: 4px; font-family: inherit; }
        input[type="color"] { padding: 2px; height: 30px; width: 50px; border: 1px solid #cbd5e1; border-radius: 4px; cursor: pointer; }

        /* Buttons */
        button { background: var(--primary); color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: 600; font-family: inherit; transition: 0.2s; }
        button:hover { opacity: 0.9; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        button.secondary { background: #64748b; }
        button.destructive { background: #fff; color: #ef4444; border: 1px solid #ef4444; }
        button.destructive:hover { background: #fef2f2; }
        
        /* File Grid */
        #dynamic-grid { display: grid; gap: 10px; margin-top: 20px; align-items: center; }
        .file-drop { border: 2px dashed #cbd5e1; padding: 10px; text-align: center; border-radius: 4px; font-size: 11px; cursor: pointer; background: #fdfdfd; transition: 0.2s; position: relative; overflow: hidden; height: 40px; display: flex; align-items: center; justify-content: center; font-weight: 500; color: #64748b; }
        .file-drop:hover { border-color: var(--primary); background: #eff6ff; color: var(--primary); }
        .file-drop input { opacity: 0; position: absolute; top:0; left:0; width:100%; height:100%; cursor: pointer; }
        .file-drop.has-file { background: #dcfce7; border-color: #22c55e; border-style: solid; color: #166534; }

        /* Canvas */
        #canvas-wrapper { overflow: auto; text-align: center; background: #e5e7eb; padding: 20px; border-radius: 4px; min-height: 300px; display: flex; align-items: center; justify-content: center; border: 2px solid #eee; }
        canvas { box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); max-width: 100%; background: white; }
        .loading { display: none; margin-left: 10px; color: var(--primary); font-weight: bold; }
        
        /* Toggle Switch Style */
        .toggle-wrapper { display: flex; align-items: center; gap: 8px; background: #f1f5f9; padding: 6px 12px; border-radius: 20px; border: 1px solid #e2e8f0; height: 18px; }
        .toggle-wrapper input { margin: 0; cursor: pointer; }
    </style>
</head>
<body>

    <div class="app-container">
        <div class="panel">
            <h2>1. Setup Grid Dimensions</h2>
            <div class="config-row">
                <div class="input-group">
                    <label>Columns (Time)</label>
                    <input type="number" id="num-cols" value="4" min="1" max="8" style="width:60px">
                </div>
                <div class="input-group">
                    <label>Rows (Channels)</label>
                    <input type="number" id="num-rows" value="2" min="1" max="6" style="width:60px">
                </div>
                <div class="input-group">
                    <label>Layout Options</label>
                    <div class="toggle-wrapper">
                        <input type="checkbox" id="include-merge" checked> 
                        <span style="font-size:13px; font-weight:600; color: #475569;">Include Merge Row</span>
                    </div>
                </div>
                <button class="destructive" onclick="buildGridUI()" style="margin-left: auto;">Reset & Create Grid</button>
            </div>
        </div>

        <div class="panel" id="grid-panel" style="display:none;">
            <h2>2. Upload Images & Configure Channels</h2>
            <div id="dynamic-grid"></div>
        </div>

        <div class="panel" id="options-panel" style="display:none;">
            <h2>3. Figure Options</h2>
            <div class="config-row" style="align-items: flex-start;">
                
                <div style="flex: 1;">
                    <h3>Layout & Scale</h3>
                    <div class="config-row">
                        <div class="input-group">
                            <label>Scale Bar (µm)</label>
                            <input type="number" id="scale-um" value="100" style="width:70px">
                        </div>
                        <div class="input-group">
                            <label>Px per µm</label>
                            <input type="number" id="px-per-um" value="2.5" step="0.1" style="width:70px">
                        </div>
                        <div class="input-group">
                            <label>Main Label</label>
                            <input type="text" id="fig-label" value="B" style="width:40px; text-align: center;">
                        </div>
                    </div>
                </div>

                <div style="flex: 1; border-left: 2px solid #eee; padding-left: 20px;">
                    <h3>Appearance Settings</h3>
                    <div class="config-row">
                        <div class="input-group">
                            <label>Header Font Size</label>
                            <input type="number" id="fs-header" value="48" style="width:60px" title="Size for column headers and main label 'B'">
                        </div>
                         <div class="input-group">
                            <label>Label Font Size</label>
                            <input type="number" id="fs-label" value="36" style="width:60px" title="Size for text inside images">
                        </div>
                        <div class="input-group">
                            <label>Bar Color</label>
                            <input type="color" id="sb-color" value="#ffff00">
                        </div>
                         <div class="input-group">
                            <label>Bar Height (%)</label>
                            <input type="number" id="sb-height" value="3" min="1" max="20" style="width:60px" title="Thickness relative to image height">
                        </div>
                    </div>
                </div>
            </div>

            <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #eee; display: flex; justify-content: flex-end; align-items: center;">
                 <span id="loading-msg" class="loading" style="margin-right: 15px;">Processing large images... please wait...</span>
                <button onclick="generateFigure()" style="font-size: 16px; padding: 12px 24px;">Generate Figure</button>
                <button class="secondary" onclick="downloadFigure()" style="margin-left: 10px; padding: 12px 24px;">Download PNG</button>
            </div>
        </div>

        <div class="panel">
            <div id="canvas-wrapper">
                <canvas id="mainCanvas"></canvas>
            </div>
        </div>
    </div>

    <script>
        // --- State ---
        let gridState = { cols: 0, rows: 0 };

        // --- 1. Build Grid UI ---
        function buildGridUI() {
            const cols = parseInt(document.getElementById('num-cols').value);
            const rows = parseInt(document.getElementById('num-rows').value);
            gridState = { cols, rows };

            const container = document.getElementById('dynamic-grid');
            container.innerHTML = ''; 
            
            // FIXED: Widen first column to 260px to prevent overlay/cramping
            container.style.gridTemplateColumns = `260px repeat(${cols}, 1fr)`;

            // Headers
            container.appendChild(createDiv('')); // Top-left spacer
            for (let c = 0; c < cols; c++) {
                const input = document.createElement('input');
                input.type = 'text';
                input.value = c === 0 ? "Naive" : (c === 1 ? "6h" : (c===2 ? "24h" : "7d"));
                input.id = `lbl-col-${c}`;
                input.style.textAlign = "center";
                input.style.fontWeight = "bold";
                container.appendChild(input);
            }

            // Channel Rows
            const defaultColors = ['green', 'red', 'blue', 'magenta', 'cyan'];
            const defaultNames = ['p-AKT', 'tdTom', 'DAPI', 'Marker', 'Marker'];

            for (let r = 0; r < rows; r++) {
                // Row Config
                const configDiv = document.createElement('div');
                configDiv.style.display = 'flex';
                configDiv.style.gap = '5px';
                configDiv.style.alignItems = 'center';
                
                const nameInput = document.createElement('input');
                nameInput.type = 'text';
                nameInput.value = defaultNames[r] || `Ch ${r+1}`;
                nameInput.id = `lbl-row-${r}`;
                nameInput.style.flex = "1";
                nameInput.style.textAlign = "right";

                const colorSelect = document.createElement('select');
                colorSelect.id = `color-row-${r}`;
                ['green', 'red', 'blue', 'magenta', 'cyan', 'yellow', 'gray'].forEach(color => {
                    const opt = document.createElement('option');
                    opt.value = color;
                    opt.text = color.charAt(0).toUpperCase() + color.slice(1);
                    if(color === defaultColors[r]) opt.selected = true;
                    colorSelect.appendChild(opt);
                });
                colorSelect.style.width = "80px";

                configDiv.appendChild(nameInput);
                configDiv.appendChild(colorSelect);
                container.appendChild(configDiv);

                // File Inputs
                for (let c = 0; c < cols; c++) {
                    const drop = document.createElement('div');
                    drop.className = 'file-drop';
                    drop.innerHTML = `<span>Drag TIF/PNG here</span><input type="file" id="file-${r}-${c}" onchange="markFile(this)">`;
                    container.appendChild(drop);
                }
            }

            document.getElementById('grid-panel').style.display = 'block';
            document.getElementById('options-panel').style.display = 'block';
        }

        // --- Helpers ---
        function createDiv(text) {
            const d = document.createElement('div');
            d.innerHTML = text;
            return d;
        }
        function markFile(input) {
            if(input.files && input.files[0]) {
                input.parentElement.classList.add('has-file');
                input.parentElement.querySelector('span').innerText = input.files[0].name;
            }
        }

        // --- 2. Generation Logic ---
        const COLOR_MAP = {
            'green':   [0, 1, 0], 'red':     [1, 0, 0], 'blue':    [0, 0, 1],
            'magenta': [1, 0, 1], 'cyan':    [0, 1, 1], 'yellow':  [1, 1, 0], 'gray':    [1, 1, 1]
        };

        async function getPixels(fileInputId) {
            const input = document.getElementById(fileInputId);
            if (!input || !input.files || !input.files[0]) return null;
            const file = input.files[0];
            const buffer = await file.arrayBuffer();

            if (file.name.match(/\.tif+$/i)) {
                const ifds = UTIF.decode(buffer);
                UTIF.decodeImage(buffer, ifds[0]);
                return { w: ifds[0].width, h: ifds[0].height, data: UTIF.toRGBA8(ifds[0]) };
            } else {
                return new Promise(resolve => {
                    const img = new Image();
                    img.onload = () => {
                        const c = document.createElement('canvas');
                        c.width = img.width; c.height = img.height;
                        const ctx = c.getContext('2d');
                        ctx.drawImage(img, 0, 0);
                        resolve({ w: img.width, h: img.height, data: ctx.getImageData(0,0,img.width,img.height).data });
                    };
                    img.src = URL.createObjectURL(file);
                });
            }
        }

        async function generateFigure() {
            document.getElementById('loading-msg').style.display = 'inline';
            await new Promise(r => setTimeout(r, 50)); // Render delay

            try {
                const cols = gridState.cols;
                const rows = gridState.rows;
                const includeMerge = document.getElementById('include-merge').checked;

                // Read Appearance Settings
                const fsHeader = parseInt(document.getElementById('fs-header').value) || 32;
                const fsLabel = parseInt(document.getElementById('fs-label').value) || 24;
                const sbColor = document.getElementById('sb-color').value;
                const sbHeightPct = (parseFloat(document.getElementById('sb-height').value) || 2) / 100;

                // 1. Find dimensions
                let baseW = 300, baseH = 300;
                let found = false;
                for(let r=0; r<rows; r++) {
                    for(let c=0; c<cols; c++) {
                        const p = await getPixels(`file-${r}-${c}`);
                        if(p) { baseW = p.w; baseH = p.h; found = true; break; }
                    }
                    if(found) break;
                }

                const canvas = document.getElementById('mainCanvas');
                const ctx = canvas.getContext('2d');
                const pad = Math.round(baseW * 0.02); 
                const headerH = fsHeader * 2; 
                const totalRows = includeMerge ? rows + 1 : rows;

                canvas.width = (baseW * cols) + (pad * (cols - 1));
                canvas.height = headerH + (baseH * totalRows) + (pad * totalRows);

                ctx.fillStyle = "white";
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // 2. Draw Column Headers
                ctx.fillStyle = "black";
                ctx.font = `bold ${fsHeader}px Arial, sans-serif`;
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                for (let c = 0; c < cols; c++) {
                    const label = document.getElementById(`lbl-col-${c}`).value;
                    const cx = (c * (baseW + pad)) + (baseW / 2);
                    ctx.fillText(label, cx, headerH / 2);
                }

                // 3. Process Images
                for (let c = 0; c < cols; c++) {
                    const x = c * (baseW + pad);
                    let mergeBuffer = new Float32Array(baseW * baseH * 3);

                    // A. Individual Channels
                    for (let r = 0; r < rows; r++) {
                        const y = headerH + (r * (baseH + pad));
                        const rawData = await getPixels(`file-${r}-${c}`);
                        const colorName = document.getElementById(`color-row-${r}`).value;
                        const mult = COLOR_MAP[colorName];
                        const imgData = ctx.createImageData(baseW, baseH);

                        if (rawData) {
                            let maxVal = 1;
                             for (let i = 0; i < rawData.data.length; i += 4) {
                                 const val = (rawData.data[i] + rawData.data[i+1] + rawData.data[i+2]) / 3;
                                 if(val > maxVal) maxVal = val;
                             }
                             const scaleFactor = 255.0 / maxVal;

                            for (let i = 0; i < imgData.data.length; i += 4) {
                                let val = (rawData.data[i] + rawData.data[i+1] + rawData.data[i+2]) / 3;
                                val = val * scaleFactor;

                                imgData.data[i]   = val * mult[0]; 
                                imgData.data[i+1] = val * mult[1]; 
                                imgData.data[i+2] = val * mult[2]; 
                                imgData.data[i+3] = 255;

                                if (includeMerge) {
                                    const pIdx = (i / 4) * 3;
                                    mergeBuffer[pIdx]   += imgData.data[i];
                                    mergeBuffer[pIdx+1] += imgData.data[i+1];
                                    mergeBuffer[pIdx+2] += imgData.data[i+2];
                                }
                            }
                        } else {
                            for (let i = 0; i < imgData.data.length; i += 4) { imgData.data[i+3] = 255; }
                        }
                        ctx.putImageData(imgData, x, y);
                        
                        if (c === 0) drawRowLabel(ctx, document.getElementById(`lbl-row-${r}`).value, x, y, fsLabel);
                    }

                    // B. Merge Channel
                    if (includeMerge) {
                        const y = headerH + (rows * (baseH + pad));
                        const mImg = ctx.createImageData(baseW, baseH);
                        for (let i = 0, p = 0; i < mImg.data.length; i += 4, p += 3) {
                            mImg.data[i]   = Math.min(255, mergeBuffer[p]);
                            mImg.data[i+1] = Math.min(255, mergeBuffer[p+1]);
                            mImg.data[i+2] = Math.min(255, mergeBuffer[p+2]);
                            mImg.data[i+3] = 255;
                        }
                        ctx.putImageData(mImg, x, y);
                        
                        if (c === 0) drawRowLabel(ctx, "merged", x, y, fsLabel);
                    }
                }

                // 4. Scale Bar
                const scaleUm = parseFloat(document.getElementById('scale-um').value);
                const pxPerUm = parseFloat(document.getElementById('px-per-um').value);
                const barW = scaleUm * pxPerUm;
                const barH = baseH * sbHeightPct; 
                
                const finalY = headerH + ((totalRows - 1) * (baseH + pad));
                const finalX = ((cols - 1) * (baseW + pad));
                
                ctx.fillStyle = sbColor;
                ctx.fillRect(finalX + baseW - barW - (baseW*0.05), finalY + baseH - barH - (baseH*0.05), barW, barH);

                // 5. Figure Label
                const figLabel = document.getElementById('fig-label').value;
                if(figLabel) {
                    ctx.fillStyle = "black";
                    ctx.font = `bold ${fsHeader * 1.2}px Arial, sans-serif`; 
                    ctx.textAlign = "left";
                    ctx.textBaseline = "top";
                    ctx.fillText(figLabel, 0, 0);
                }

            } catch (e) {
                console.error(e);
                alert("Error: " + e.message);
            }
            document.getElementById('loading-msg').style.display = 'none';
        }

        function drawRowLabel(ctx, text, x, y, fontSize) {
            ctx.save();
            ctx.fillStyle = "white";
            ctx.font = `bold ${fontSize}px Arial, sans-serif`;
            ctx.shadowColor = "black";
            ctx.shadowBlur = fontSize / 5;
            ctx.shadowOffsetX = fontSize / 15; 
            ctx.shadowOffsetY = fontSize / 15;
            ctx.textAlign = "left";
            ctx.textBaseline = "top";
            const padding = 20; 
            ctx.fillText(text, x + padding, y + padding);
            ctx.restore();
        }

        function downloadFigure() {
            const link = document.createElement('a');
            link.download = 'scientific_figure.png';
            try {
                 link.href = document.getElementById('mainCanvas').toDataURL("image/png");
            } catch(e) {
                 link.href = document.getElementById('mainCanvas').toDataURL("image/jpeg", 0.9);
            }
            link.click();
        }

        // Init
        buildGridUI();
    </script>
</body>
</html>
